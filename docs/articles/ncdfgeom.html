<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NetCDF Geometry and Timeseries Tools • ncdfgeom</title>
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="NetCDF Geometry and Timeseries Tools">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ncdfgeom</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released package">0.4.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/ncdfgeom.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/geometry.html">ncdfgeom geometry tools</a>
    </li>
    <li>
      <a href="../articles/timeseries.html">ncdfgeom</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/USGS-R/ncdfgeom#readme">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>NetCDF Geometry and Timeseries Tools</h1>
                        <h4 class="author">David Blodgett</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/USGS-R/ncdfgeom#readme/blob/master/vignettes/ncdfgeom.Rmd"><code>vignettes/ncdfgeom.Rmd</code></a></small>
      <div class="hidden name"><code>ncdfgeom.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p><code>ncdfgeom</code> is intended to convert spatial geometries and timeseries that would typically be stored in two or more files into a single file. Geometries in this context could be vector representations of watersheds, cities, rivers, roads, monitoring sites, etc. Geometries are often associated with attributes and possibly timeseries of observed or estimated characteristics of the geometries. Theoretically any quantity for which unique attributes and time series exist for each geometry “instance” could be written and / or read with the functions in this package.</p>
<p><code>ncdfgeom</code> is a work in progress. Please review the <a href="https://github.com/USGS-R/ncdfgeom/issues">“issues”</a> list to submit issues and/or see what changes are planned.</p>
<p>For spatial geometries and their attributes, <code>ncdfgeom</code> supports the <code>sf</code> and <code>sp</code> package formats. At the time of writing, 3d geometries and multipoint geometries are not supported.</p>
<p>For timeseries, two formats are supported: 1. a <code>data.frame</code> with timesteps in rows and geometry “instances” in columns with required attributes of geometry “instances” provided seperately. (shown below) 1. a long format where each row contains all the geometry “instance” metadata, a time stamp, and the variables to be stored for that time step.</p>
<p>The first lends its self to data where the same timestamps are used for every row and data exists for all geometry instances for all time steps – it is sometimes referred to as the orthoganal array encoding. The second lends its self to data where each geometry instance has unique timesteps and/or data is not available for each geometry instance at the same timesteps.</p>
</div>
<div id="installation" class="section level2">
<h2 class="hasAnchor">
<a href="#installation" class="anchor"></a>Installation</h2>
<p>At the time of writing, installation is only available via <code>devtools</code> or building the package directly as one would for development purposes.</p>
<pre><code>install.packages("devtools")
devtools::install_github("USGS-R/ncdfgeom")</code></pre>
<p>There is an intention to have this package available via CRAN soon.</p>
</div>
<div id="write-data" class="section level2">
<h2 class="hasAnchor">
<a href="#write-data" class="anchor"></a>Write Data</h2>
<p>In this example, we’ll work with precipitation data available by climate division from NOAA at: <a href="https://doi.org/10.7289/V5M32STR">doi:10.7289/V5M32STR</a></p>
<p>Code to download and get it ready for ncdfgeom is shown at the end of this vignette. Let’s look at the names and dimensions of the two <code>data.frames</code> that we’ll start with: <code>prcp_data</code> and <code>climdiv_poly</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="co"># prcp_data is in "wide" format with dates as rows.</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"><span class="kw">dim</span>(prcp_data)</a></code></pre></div>
<pre><code>## [1] 1488  345</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="co"># The climate division ids are the names prcp_data.</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="kw">str</span>(<span class="kw">names</span>(prcp_data)) </a></code></pre></div>
<pre><code>##  chr [1:345] "date" "0101" "0102" "0103" "0104" "0105" "0106" "0107" ...</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="co"># climdiv_poly is an sf data.frame with geometry instances as rows.</span></a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="kw">dim</span>(climdiv_poly)</a></code></pre></div>
<pre><code>## [1] 344   3</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="co"># climdiv_poly has three variables, one of which is the geometries.</span></a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="kw">str</span>(<span class="kw">names</span>(climdiv_poly))</a></code></pre></div>
<pre><code>##  chr [1:3] "CLIMDIV" "CLIMDIV_NAME" "geometry"</code></pre>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1"><span class="co"># Climate division identifiers are in the CLIMDIV variable.</span></a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="kw">str</span>(climdiv_poly<span class="op">$</span>CLIMDIV)</a></code></pre></div>
<pre><code>##  chr [1:344] "0101" "0102" "0103" "0104" "0105" "0106" "0107" "0108" ...</code></pre>
<p>As shown above, we have two <code>data.frame</code>s. One has 344 columns and the other 344 rows. These 344 climate divisions will be our “instance” dimension when we write to NetCDF.</p>
<p>The NetCDF discrete sampling geometries timeSeries standard requires point lat/lon coordinate locations for timeSeries data. In the code below, we calculate these values and write the timeseries data to a netcdf file.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">climdiv_centroids &lt;-<span class="st"> </span>climdiv_poly <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-2" data-line-number="2"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dv">5070</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># Albers Equal Area</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3"><span class="st">  </span><span class="kw">st_set_agr</span>(<span class="st">"constant"</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-4" data-line-number="4"><span class="st">  </span><span class="kw">st_centroid</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-5" data-line-number="5"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dv">4269</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co">#NAD83 Lat/Lon</span></a>
<a class="sourceLine" id="cb12-6" data-line-number="6"><span class="st">  </span><span class="kw">st_coordinates</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb12-7" data-line-number="7"><span class="st">  </span><span class="kw">as.data.frame</span>()</a>
<a class="sourceLine" id="cb12-8" data-line-number="8"></a>
<a class="sourceLine" id="cb12-9" data-line-number="9">nc_file &lt;-<span class="st"> "climdiv_prcp.nc"</span></a>
<a class="sourceLine" id="cb12-10" data-line-number="10"></a>
<a class="sourceLine" id="cb12-11" data-line-number="11"><span class="kw"><a href="../reference/write_timeseries_dsg.html">write_timeseries_dsg</a></span>(<span class="dt">nc_file =</span> nc_file, </a>
<a class="sourceLine" id="cb12-12" data-line-number="12">                     <span class="dt">station_names =</span> climdiv_poly<span class="op">$</span>CLIMDIV, </a>
<a class="sourceLine" id="cb12-13" data-line-number="13">                     <span class="dt">lats =</span> climdiv_centroids<span class="op">$</span>Y, </a>
<a class="sourceLine" id="cb12-14" data-line-number="14">                     <span class="dt">lons =</span> climdiv_centroids<span class="op">$</span>X, </a>
<a class="sourceLine" id="cb12-15" data-line-number="15">                     <span class="dt">times =</span> prcp_data<span class="op">$</span>date, </a>
<a class="sourceLine" id="cb12-16" data-line-number="16">                     <span class="dt">data =</span> prcp_data[<span class="dv">2</span><span class="op">:</span><span class="kw">ncol</span>(prcp_data)], </a>
<a class="sourceLine" id="cb12-17" data-line-number="17">                     <span class="dt">data_unit =</span> <span class="kw">rep</span>(<span class="st">"inches"</span>, (<span class="kw">ncol</span>(prcp_data) <span class="op">-</span><span class="st"> </span><span class="dv">1</span>)), </a>
<a class="sourceLine" id="cb12-18" data-line-number="18">                     <span class="dt">data_prec =</span> <span class="st">"float"</span>, </a>
<a class="sourceLine" id="cb12-19" data-line-number="19">                     <span class="dt">data_metadata =</span> <span class="kw">list</span>(<span class="dt">name =</span> <span class="st">"climdiv_prcp_inches"</span>, </a>
<a class="sourceLine" id="cb12-20" data-line-number="20">                                          <span class="dt">long_name =</span> <span class="st">"Estimated Monthly Climate Division Precipitation in Inches"</span>), </a>
<a class="sourceLine" id="cb12-21" data-line-number="21">                     <span class="dt">attributes =</span> <span class="kw">list</span>(<span class="dt">title =</span> <span class="st">"Demonstation of ncdfgeom"</span>), </a>
<a class="sourceLine" id="cb12-22" data-line-number="22">                     <span class="dt">add_to_existing =</span> <span class="ot">FALSE</span>) -&gt;<span class="st"> </span>nc_file</a></code></pre></div>
<p>Now we have a file with a structure as shown in the <code>ncdump</code> output below.</p>
<pre><code>ncdump -sh climdiv_prcp.nc 
netcdf climdiv_prcp {
dimensions:
    station = 344 ;
    time = 1488 ;
    name_strlen = 4 ;
variables:
    double lat(station) ;
        lat:units = "degrees_north" ;
        lat:_FillValue = -999. ;
        lat:long_name = "latitude of the observation" ;
        lat:standard_name = "latitude" ;
    double lon(station) ;
        lon:units = "degrees_east" ;
        lon:_FillValue = -999. ;
        lon:long_name = "longitude of the observation" ;
        lon:standard_name = "longitude" ;
    double time(time) ;
        time:units = "days since 1970-01-01 00:00:00" ;
        time:_FillValue = -999. ;
        time:long_name = "time of measurement" ;
        time:standard_name = "time" ;
    char station_name(station, name_strlen) ;
        station_name:long_name = "Station Names" ;
        station_name:cf_role = "timeseries_id" ;
        station_name:standard_name = "station_id" ;
    float climdiv_prcp_inches(station, time) ;
        climdiv_prcp_inches:units = "inches" ;
        climdiv_prcp_inches:_FillValue = -999.f ;
        climdiv_prcp_inches:long_name = "Estimated Monthly Climate Division Precipitation in Inches" ;
        climdiv_prcp_inches:coordinates = "time lat lon" ;

// global attributes:
        :Conventions = "CF-1.7" ;
        :featureType = "timeSeries" ;
        :cdm_data_type = "Station" ;
        :standard_name_vocabulary = "CF-1.7" ;
        :title = "Demonstation of ncdfgeom" ;
        :_Format = "classic" ;
}</code></pre>
<p>Next we can write the geometry data into the same file.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1"><span class="kw"><a href="../reference/write_geometry.html">write_geometry</a></span>(<span class="dt">nc_file =</span> <span class="st">"climdiv_prcp.nc"</span>, </a>
<a class="sourceLine" id="cb14-2" data-line-number="2">               <span class="dt">geomData =</span> climdiv_poly,</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">               <span class="dt">variables =</span> <span class="st">"climdiv_prcp_inches"</span>) -&gt;<span class="st"> </span>nc_file</a></code></pre></div>
<p>Now we have a file with an <code>ncdump</code> that looks like:</p>
<pre><code>ncdump -sh climdiv_prcp.nc 
netcdf climdiv_prcp {
dimensions:
    station = 344 ;
    time = 1488 ;
    name_strlen = 4 ;
    char = 30 ;
    instance = 344 ;
    node = 8198 ;
    part = 420 ;
variables:
    double lat(station) ;
        lat:units = "degrees_north" ;
        lat:_FillValue = -999. ;
        lat:long_name = "latitude of the observation" ;
        lat:standard_name = "latitude" ;
    double lon(station) ;
        lon:units = "degrees_east" ;
        lon:_FillValue = -999. ;
        lon:long_name = "longitude of the observation" ;
        lon:standard_name = "longitude" ;
    double time(time) ;
        time:units = "days since 1970-01-01 00:00:00" ;
        time:_FillValue = -999. ;
        time:long_name = "time of measurement" ;
        time:standard_name = "time" ;
    char station_name(station, name_strlen) ;
        station_name:long_name = "Station Names" ;
        station_name:cf_role = "timeseries_id" ;
        station_name:standard_name = "station_id" ;
    float climdiv_prcp_inches(station, time) ;
        climdiv_prcp_inches:units = "inches" ;
        climdiv_prcp_inches:_FillValue = -999.f ;
        climdiv_prcp_inches:long_name = "Estimated Monthly Climate Division Precipitation in Inches" ;
        climdiv_prcp_inches:coordinates = "time lat lon" ;
        climdiv_prcp_inches:grid_mapping = "grid_mapping" ;
        climdiv_prcp_inches:geometry = "geometry_container" ;
    char CLIMDIV(instance, char) ;
        CLIMDIV:units = "unknown" ;
        CLIMDIV:grid_mapping = "grid_mapping" ;
        CLIMDIV:geometry = "geometry_container" ;
    char CLIMDIV_NAME(instance, char) ;
        CLIMDIV_NAME:units = "unknown" ;
        CLIMDIV_NAME:grid_mapping = "grid_mapping" ;
        CLIMDIV_NAME:geometry = "geometry_container" ;
    double x(node) ;
        x:units = "degrees_east" ;
        x:standard_name = "longitude" ;
        x:axis = "X" ;
    double y(node) ;
        y:units = "degrees_north" ;
        y:standard_name = "latitude" ;
        y:axis = "Y" ;
    float geometry_container ;
        geometry_container:geometry_type = "polygon" ;
        geometry_container:node_count = "node_count" ;
        geometry_container:node_coordinates = "x y" ;
        geometry_container:grid_mapping = "grid_mapping" ;
        geometry_container:part_node_count = "part_node_count" ;
        geometry_container:interior_ring = "interior_ring" ;
    int node_count(instance) ;
        node_count:long_name = "count of coordinates in each instance geometry" ;
    float grid_mapping ;
        grid_mapping:grid_mapping_name = "latitude_longitude" ;
        grid_mapping:semi_major_axis = 6378137. ;
        grid_mapping:inverse_flattening = 298.257223563 ;
        grid_mapping:longitude_of_prime_meridian = 0. ;
    int part_node_count(part) ;
        part_node_count:long_name = "count of nodes in each geometry part" ;
    int interior_ring(part) ;
        interior_ring:long_name = "type of each geometry part" ;

// global attributes:
        :Conventions = "CF-1.8" ;
        :featureType = "timeSeries" ;
        :cdm_data_type = "Station" ;
        :standard_name_vocabulary = "CF-1.7" ;
        :title = "Demonstation of ncdfgeom" ;
        :_Format = "classic" ;
}</code></pre>
<p>For more information about the polygon and timeseries data structures used here, see the <a href="http://cfconventions.org/cf-conventions/cf-conventions.html">NetCDF-CF standard.</a> ## Read Data</p>
<p>Now that we have all our data in a single file, we can read it back in.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">prcp_data &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_timeseries_dsg.html">read_timeseries_dsg</a></span>(<span class="st">"climdiv_prcp.nc"</span>)</a>
<a class="sourceLine" id="cb16-2" data-line-number="2">climdiv_poly &lt;-<span class="st"> </span><span class="kw"><a href="../reference/read_geometry.html">read_geometry</a></span>(<span class="st">"climdiv_prcp.nc"</span>)</a>
<a class="sourceLine" id="cb16-3" data-line-number="3"></a>
<a class="sourceLine" id="cb16-4" data-line-number="4"><span class="co"># In the future, the response from read_timeseries_dsg could be a formal R object.</span></a>
<a class="sourceLine" id="cb16-5" data-line-number="5"><span class="co"># Right now, it is a list that looks like:</span></a>
<a class="sourceLine" id="cb16-6" data-line-number="6"><span class="kw">names</span>(prcp_data)</a></code></pre></div>
<pre><code>## [1] "time"              "lats"              "lons"             
## [4] "varmeta"           "data_unit"         "data_prec"        
## [7] "data_frames"       "global_attributes"</code></pre>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1"><span class="kw">class</span>(prcp_data<span class="op">$</span>time)</a></code></pre></div>
<pre><code>## [1] "POSIXct" "POSIXt"</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1"><span class="kw">names</span>(prcp_data<span class="op">$</span>varmeta<span class="op">$</span>climdiv_prcp_inches)</a></code></pre></div>
<pre><code>## [1] "name"      "long_name"</code></pre>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">prcp_data<span class="op">$</span>data_unit</a></code></pre></div>
<pre><code>## climdiv_prcp_inches 
##            "inches"</code></pre>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb24-1" data-line-number="1">prcp_data<span class="op">$</span>data_prec</a></code></pre></div>
<pre><code>## climdiv_prcp_inches 
##             "float"</code></pre>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb26-1" data-line-number="1"><span class="kw">str</span>(<span class="kw">names</span>(prcp_data<span class="op">$</span>data_frames<span class="op">$</span>climdiv_prcp_inches))</a></code></pre></div>
<pre><code>##  chr [1:344] "0101" "0102" "0103" "0104" "0105" "0106" "0107" "0108" ...</code></pre>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb28-1" data-line-number="1">prcp_data<span class="op">$</span>global_attributes</a></code></pre></div>
<pre><code>## $nc_summary
## [1] 0
## 
## $nc_date_created
## [1] 0
## 
## $nc_creator_name
## [1] 0
## 
## $nc_creator_email
## [1] 0
## 
## $nc_project
## [1] 0
## 
## $nc_proc_level
## [1] 0
## 
## $nc_title
## [1] "Demonstation of ncdfgeom"</code></pre>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb30-1" data-line-number="1"><span class="kw">names</span>(climdiv_poly)</a></code></pre></div>
<pre><code>## [1] "CLIMDIV"      "CLIMDIV_NAME" "geometry"</code></pre>
<p>To understand what is actually in this file, let’s visualize the data we just read. Below we join a sum of the precipitation timeseries to the climate division polygons and plot them up.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb32-1" data-line-number="1">climdiv_poly &lt;-<span class="st"> </span>climdiv_poly <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-2" data-line-number="2"><span class="st">  </span><span class="kw">st_transform</span>(<span class="dv">3857</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="co"># web mercator</span></a>
<a class="sourceLine" id="cb32-3" data-line-number="3"><span class="st">  </span><span class="kw">st_simplify</span>(<span class="dt">dTolerance =</span> <span class="dv">5000</span>)</a>
<a class="sourceLine" id="cb32-4" data-line-number="4"></a>
<a class="sourceLine" id="cb32-5" data-line-number="5">title &lt;-<span class="st"> </span><span class="kw">paste0</span>(<span class="st">"</span><span class="ch">\n</span><span class="st"> Sum of: "</span>, prcp_data<span class="op">$</span>varmeta<span class="op">$</span>climdiv_prcp_inches<span class="op">$</span>long_name, <span class="st">"</span><span class="ch">\n</span><span class="st">"</span>, </a>
<a class="sourceLine" id="cb32-6" data-line-number="6">                <span class="kw">format</span>(prcp_data<span class="op">$</span>time[<span class="dv">1</span>], </a>
<a class="sourceLine" id="cb32-7" data-line-number="7">                         <span class="st">"%Y-%m"</span>, <span class="dt">tz =</span> <span class="st">"UTC"</span>), <span class="st">"-"</span>, </a>
<a class="sourceLine" id="cb32-8" data-line-number="8">                <span class="kw">format</span>(prcp_data<span class="op">$</span>time[<span class="kw">length</span>(prcp_data<span class="op">$</span>time)], </a>
<a class="sourceLine" id="cb32-9" data-line-number="9">                         <span class="st">"%Y-%m"</span>, <span class="dt">tz =</span> <span class="st">"UTC"</span>))</a>
<a class="sourceLine" id="cb32-10" data-line-number="10"></a>
<a class="sourceLine" id="cb32-11" data-line-number="11">prcp_sum &lt;-<span class="st"> </span><span class="kw">apply</span>(prcp_data<span class="op">$</span>data_frames<span class="op">$</span>climdiv_prcp_inches, </a>
<a class="sourceLine" id="cb32-12" data-line-number="12">                  <span class="dv">2</span>, sum, <span class="dt">na.rm =</span> <span class="ot">TRUE</span>)</a>
<a class="sourceLine" id="cb32-13" data-line-number="13"></a>
<a class="sourceLine" id="cb32-14" data-line-number="14">prcp &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">CLIMDIV =</span> <span class="kw">names</span>(prcp_sum), </a>
<a class="sourceLine" id="cb32-15" data-line-number="15">                   <span class="dt">prcp =</span> <span class="kw">as.numeric</span>(prcp_sum), </a>
<a class="sourceLine" id="cb32-16" data-line-number="16">                   <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb32-17" data-line-number="17"><span class="st">  </span><span class="kw">right_join</span>(climdiv_poly, <span class="dt">by =</span> <span class="st">"CLIMDIV"</span>) <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb32-18" data-line-number="18"><span class="st">  </span><span class="kw">st_as_sf</span>()</a>
<a class="sourceLine" id="cb32-19" data-line-number="19"></a>
<a class="sourceLine" id="cb32-20" data-line-number="20"><span class="kw">plot</span>(prcp[<span class="st">"prcp"</span>], <span class="dt">lwd =</span> <span class="fl">0.1</span>, <span class="dt">pal =</span> p_colors, </a>
<a class="sourceLine" id="cb32-21" data-line-number="21">     <span class="dt">breaks =</span> <span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">14000</span>, <span class="dv">1000</span>),</a>
<a class="sourceLine" id="cb32-22" data-line-number="22">     <span class="dt">main =</span> title,</a>
<a class="sourceLine" id="cb32-23" data-line-number="23">     <span class="dt">key.pos =</span> <span class="dv">3</span>, <span class="dt">key.length =</span> <span class="kw">lcm</span>(<span class="dv">20</span>))</a></code></pre></div>
<p><img src="ncdfgeom_files/figure-html/plot-1.png" width="768"></p>
<p>This is the code used to download and prep the precipitation data.</p>
<p>Here’s the <code>p_colors</code> function used in plotting above.</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb33-1" data-line-number="1">p_colors &lt;-<span class="st"> </span><span class="cf">function</span> (n, <span class="dt">name =</span> <span class="kw">c</span>(<span class="st">"precip_colors"</span>)) {</a>
<a class="sourceLine" id="cb33-2" data-line-number="2"><span class="co"># Thanks! https://quantdev.ssri.psu.edu/tutorials/generating-custom-color-palette-function-r</span></a>
<a class="sourceLine" id="cb33-3" data-line-number="3">    p_rgb &lt;-<span class="st"> </span><span class="kw">col2rgb</span>(<span class="kw">c</span>(<span class="st">"#FAFBF3"</span>, <span class="st">"#F0F8E3"</span>, <span class="st">"#D4E9CA"</span>, </a>
<a class="sourceLine" id="cb33-4" data-line-number="4">                       <span class="st">"#BBE0CE"</span>, <span class="st">"#B7DAD0"</span>, <span class="st">"#B0CCD7"</span>, </a>
<a class="sourceLine" id="cb33-5" data-line-number="5">                       <span class="st">"#A9B8D7"</span>, <span class="st">"#A297C2"</span>, <span class="st">"#8F6F9E"</span>, </a>
<a class="sourceLine" id="cb33-6" data-line-number="6">                       <span class="st">"#684A77"</span>, <span class="st">"#41234D"</span>))</a>
<a class="sourceLine" id="cb33-7" data-line-number="7">    precip_colors =<span class="st"> </span><span class="kw">rgb</span>(p_rgb[<span class="dv">1</span>,],p_rgb[<span class="dv">2</span>,],p_rgb[<span class="dv">3</span>,],<span class="dt">maxColorValue =</span> <span class="dv">255</span>)</a>
<a class="sourceLine" id="cb33-8" data-line-number="8">    name =<span class="st"> </span><span class="kw">match.arg</span>(name)</a>
<a class="sourceLine" id="cb33-9" data-line-number="9">    orig =<span class="st"> </span><span class="kw">eval</span>(<span class="kw">parse</span>(<span class="dt">text =</span> name))</a>
<a class="sourceLine" id="cb33-10" data-line-number="10">    rgb =<span class="st"> </span><span class="kw">t</span>(<span class="kw">col2rgb</span>(orig))</a>
<a class="sourceLine" id="cb33-11" data-line-number="11">    temp =<span class="st"> </span><span class="kw">matrix</span>(<span class="ot">NA</span>, <span class="dt">ncol =</span> <span class="dv">3</span>, <span class="dt">nrow =</span> n)</a>
<a class="sourceLine" id="cb33-12" data-line-number="12">    x =<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, , <span class="kw">length</span>(orig))</a>
<a class="sourceLine" id="cb33-13" data-line-number="13">    xg =<span class="st"> </span><span class="kw">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, , n)</a>
<a class="sourceLine" id="cb33-14" data-line-number="14">    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>) {</a>
<a class="sourceLine" id="cb33-15" data-line-number="15">        hold =<span class="st"> </span><span class="kw">spline</span>(x, rgb[, k], <span class="dt">n =</span> n)<span class="op">$</span>y</a>
<a class="sourceLine" id="cb33-16" data-line-number="16">        hold[hold <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>] =<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb33-17" data-line-number="17">        hold[hold <span class="op">&gt;</span><span class="st"> </span><span class="dv">255</span>] =<span class="st"> </span><span class="dv">255</span></a>
<a class="sourceLine" id="cb33-18" data-line-number="18">        temp[, k] =<span class="st"> </span><span class="kw">round</span>(hold)</a>
<a class="sourceLine" id="cb33-19" data-line-number="19">    }</a>
<a class="sourceLine" id="cb33-20" data-line-number="20">    palette =<span class="st"> </span><span class="kw">rgb</span>(temp[, <span class="dv">1</span>], temp[, <span class="dv">2</span>], temp[, <span class="dv">3</span>], <span class="dt">maxColorValue =</span> <span class="dv">255</span>)</a>
<a class="sourceLine" id="cb33-21" data-line-number="21">    palette</a>
<a class="sourceLine" id="cb33-22" data-line-number="22">}</a></code></pre></div>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb34-1" data-line-number="1"><span class="kw">unlink</span>(<span class="st">"GIS*"</span>)</a>
<a class="sourceLine" id="cb34-2" data-line-number="2"><span class="kw">unlink</span>(<span class="st">"CONUS_CLIMATE_DIVISIONS.shp.zip"</span>)</a>
<a class="sourceLine" id="cb34-3" data-line-number="3"><span class="kw">unlink</span>(<span class="st">"prcp.txt"</span>)</a>
<a class="sourceLine" id="cb34-4" data-line-number="4"><span class="kw">unlink</span>(<span class="st">"climdiv_prcp.nc"</span>)</a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#installation">Installation</a></li>
      <li><a href="#write-data">Write Data</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by David Blodgett.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
